# 수집에 활용할 기술

## 카프카란

            카프카는 Message Oriented Middleware 소프트웨어 중 하나인데 대규모로 발생하는 작은 데이터들이 있는데 초당 수십, 수백, 수천건이
            발생하는데 이 데이터들을 다 동기화 처리하기에는 무리가 있다. 그래서 이를 비동기 방식으로 처리를 하게 된다.
            비동기 방식 처리를 하기 위해서 중간에 큐나 토픽 같은 것을 놓는데 이 큐나 토픽들이 버퍼 역할을 한다.
            원천에서 발생하는 데이터를 최종 목표 시스템에 저장하는 것이 목적인데 카프카가 버퍼 역할을 해주고 트랜잭션 처리도
            중간에 관여해준다. 그럼으로써 대규모 메시지 데이터들을 안정적으로 처리하고 또 빠르게 처리할 수 있는 강력한 기능과
            아키텍처를 제공해주는 것이 카프카이다.

### 주요 구성 요소

- Broker     : 카프카의 서비스 인스턴스로서, 다수의 Broker를 클러스터로 구성하고 Topic이 생성되는 물리적 서버

- Topic      : Broker에서 데이터의 발행/소비 처리를 위한 저장소

- Provider   : Broker의 특정 Topic에 데이터를 전송하는 역할로서 애플리케이션에서 카프카 라이브러리를 이용해 구현

- Consumer   : Broker의 특정 Topic에서 데이어틀 수신하는 역할로서 애플리케이션에서 카프카 라이브러리를 이용해 구현



### 카프카 아키텍처 유형 - 싱글 브로커/싱글 노드

![Cap 2021-07-18 19-36-19-819](https://user-images.githubusercontent.com/76901290/126064133-ea0005f0-3866-4441-98e2-ca742d9dfb64.jpg)


            카프카의 아키텍처는 심플하게 구성할 수 있는 아키텍처가 있는데 싱글 노드에 브로커를 하나 놓으면 된다.
            이게 물리적인 서버가 되고 이 안의 카프카 브로커를 하나 놓고 여기에 토픽을 위치시키는 것이다.
            카프카 아키텍처는 주키퍼를 활용해야한다는 특징을 가지고 있다. 이러한 카프카 아키텍처는 대규모 발행 소비 요건이 없고
            업무 도메인이 단순할 때 주로 많이 이용을 한다.

### 카프카 아키텍처 유형 - 멀티 브로커/싱글 노드

![Cap 2021-07-18 19-37-06-330](https://user-images.githubusercontent.com/76901290/126064135-61b1d478-3684-4b2e-a2d6-8e938745a960.jpg)

            하나의 물리적인 서비이기는 하나 이 안에서 멀티 브로커를 놓을 수 있다. 마치 카프카가 두대인것처럼 구성을 해 볼 수 있는데
            이러한 구성은 카프카 서버가 한대이므로 대규모 발행 소비 요건을 커버하기는 어렵지만 업무 도메인에서 복잡한 메세지 처리를 할 때
            주로 사용하는 아키텍처이다.

### 카프카 아키텍처 유형 - 멀티 브로커/멀티 노드

![Cap 2021-07-18 19-37-25-029](https://user-images.githubusercontent.com/76901290/126064137-19532658-5720-4e74-8863-6fa5159e73f5.jpg)

            주로 많이 실상용 환경에서 사용하는 카프카 아키텍처이다. 물리적인 노드가 두대가 있다.
            그리고 이 안에서의 여러개의 브로커들을 만들어 놓는것이다. 브로커 안에 여러개의 토픽들이 존재하는데
            마치 하나의 토픽처럼 토픽들을 하나로 묶을 수 있다. 이렇게 구성을 해서 Provider가 전송한 메세지들이
            주변의 다른 노드에 Broker에 복제가 되서 안정적인 처리가 가능하게 하기도 하고 Consumer 입장에서 한 곳에서
            빼오는 것보다 여러 곳에서 빼오는 것이 좋기 때문에 예를 들어서 Consumer1은 Multi Node1를 바라보게 하고
            Consumer2는 Multi Node2를 바라보게 하고 Consumer1과 Consumer2가 같은 저장소를 바라보게 한다.
            대규모 메세지들이 발생을 하고 대규모 컨수머가 있을 때 안정적으로 메세지 데이터들을 처리해야할 때 사용하는
            아키텍처이다. 대규모 발행 소비 데이터 처리에 적합하고 물리적으로 나눠진 브로커 간에 복제가 가능해서
            안정성이 높다. 업무 도메인별 메세지 그룹을 분류할 수가 있어서 복잡한 메세지 송수신 활용에 적합한 아키텍처이다.


### 카프카 활용 방안1

![Cap 2021-07-18 19-37-44-531](https://user-images.githubusercontent.com/76901290/126064141-d6115b13-c51c-4c25-a392-7dab7948d9b1.jpg)

            스마트카에서 발생하는 운전자에 대한 실시간 이벤트 데이터들을 플럼에 수집을 해서 곧바로 하둡에 저장하지 않고
            카프카에 일단 플럼이 전송을 하게 된다. 카프카에 저장된 데이터들은 별도의 트랜잭션 관리가 돼서 최종 하둡에 저장이
            될 때 안정적으로 저장이 될 수 있도록 도중에 실패가 발생하면 실패된 메세지는 다시 rollback 해서 돌아가는 트랜잭션
            처리까지 카프카가 해주게 된다.

### 카프카 활용 방안2

![Cap 2021-07-18 19-37-59-015](https://user-images.githubusercontent.com/76901290/126064143-41e9ccba-609b-4be5-aeb8-57de0ddc8dea.jpg)


            스마트카에서 실시간으로 발생하는 로그 데이터를 플럼이 수집해서 Hbase라는 곳에 저장을 한다.
            이것은 카프카가 없을 때를 이야기하는 상황이다. 카프카가 없으면 플럼이 수집하자마자 곧바로 Hbase에 저장을 해야한다.
            그런데 Hbase에서 뭔가 장애가 발생한 경우 예를 들어 Hbase가 셧다운이 됐다던지 플럼과 Hbase 사이에 네트워크 장애가
            발생하는 경우가 생겼음에도 불구하고 스마트카 실시간 로그는 계속 발생하고 이 상황에서 플럼은 이 로그를 빨리빨리 수집을 해서 Hbase에
            저장을 해야한다. 하지만 Hbase에 장애가 생겼으므로 데이터는 계속 플럼에 쌓이게 된다. 플럼은 수집 소프트웨어지 중간에 버퍼링 해주는
            요소가 있지만 그것이 크지 않아 2차 장애가 발생하게 되어 전체적인 아키텍처는 장애에 매우 취약하다고 볼 수 있다.


### 카프카 활용 방안3

![Cap 2021-07-18 19-38-20-646](https://user-images.githubusercontent.com/76901290/126064147-89b4efc7-ef78-479d-bea9-6a5cc62b0108.jpg)

            위의 상황을 해결하기 위해서는 Hbase와 플럼 사이에 배치시켜야한다.
            이런 구조를 만들면 스마트카에서 로그가 끊임없이 발생하고 있고 플럼이 이를 수집을 해서 카프카에 전송을 한다.
            Hbase에 장애가 발생하더라도 카프카는 멀티 노드로 구성하고 대규모 클러스터로 만들어낼 수 있으므로
            Hbase 복구 시간동안 카프카는 메세지들을 담아놓게 되고 복구가 되면 쌓인 데이터를 꺼내서 최종 Hbase에 저장할 수 있는
            장애를 극복할 수 있는 아키텍처를 만들어낼 수 있다. 카프카는 빅데이터 시스템에서만 사용되는게 아니라 다양한 서비스와
            도메인에서 아키텍처적으로 비동기적인 대규모 메세지 처리를 만들 때 사용할 수 있는 소프트웨어이다.
            특히 요즘에 Iot 기기에서 다량으로 발생하는 메세지 데이터들을 DB에 저장해야하는데 곧바로 저장하기 부담스럽기 때문에
            카프카를 거쳐서 저장하는 구조 또는 사용자들의 스마트카 또는 SNS 같은 곳에서 대규모 트래픽 로그들이 발생할 경우
            분산 임시 저장소가 필요한데 이 역할을 카프카가 맡게 된다.



### 출처

"15일간의 빅데이터 파일럿 프로젝트",인프런,https://www.inflearn.com/course/%EB%B9%85%EB%8D%B0%EC%9D%B4%ED%84%B0-%ED%8C%8C%EC%9D%BC%EB%9F%BF-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/dashboard
